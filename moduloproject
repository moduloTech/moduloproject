#!/bin/sh

local_project_directory=`pwd -P`
project_name=${local_project_directory##*/}
docker_project_directory="/$project_name"
git_email=`git config --get user.email`
git_name=`git config --get user.name`

####################
# Error handling
####################
set -eE -o functrace
function failure() {
  local lineno=$1
  local msg=$2
  echo "Failed at $lineno: $msg"
}
trap 'failure ${LINENO} "$BASH_COMMAND"' ERR

echo "Generate project $project_name"

script='echo "Installing last version of Rails" && \
    gem install rails --no-document && \
    echo "Installing last version of Bundler" && \
    gem update --system && \
    echo "Configure name for default branch of git" && \
    git config --global init.defaultBranch master && \
    echo "Generate new Rails application" && \
    rails new . -d postgresql -m https://raw.githubusercontent.com/moduloTech/moduloproject/master/template.rb'

docker run --name moduloproject --pull=always --rm -a STDOUT -ti -w $docker_project_directory \
  -v $local_project_directory:$docker_project_directory \
  -e "GIT_EMAIL=$git_email" -e "GIT_NAME=$git_name" \
  ruby:latest bash -c "$script"
